# ุฏููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูููุงุณ ุงูุฃุฑุจุงุญ ุจุฏูุฉ

## ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ูุดุฑุญ ููุฐูุงุก ุงูุงุตุทูุงุนู ููููุฉ ููุงุณ ุงูุฃุฑุจุงุญ ุจุฏูุฉ ุนุงููุฉ ุฌุฏุงู ุจุงุณุชุฎุฏุงู ููุณ ุงููููุฌูุฉ ุงููุณุชุฎุฏูุฉ ูู:
- ุงูุฌุฑุฏ ุงูุดูุฑู (`getMonthlySalesSummary`)
- ุชูุงุฑูุฑ ุงูุจุถุงุนุฉ (`getProductSalesData`)
- ุชูุงุฑูุฑ ุงูุฃุดุฎุงุต (`getCustomerProfitData`)

---

## ุงููููุฌูุฉ ุงูุฃุณุงุณูุฉ

### 1. ุญุณุงุจ ุงูุชูููุฉ ุงูุฏูููุฉ

#### ุงููุงุนุฏุฉ ุงูุฃุณุงุณูุฉ:
```
ุงูุชูููุฉ = ุชูููุฉ ุงููุญุฏุฉ ร ุงููููุฉ
```

#### ุงูุชูุงุตูู:
```dart
// 1. ุชุญุฏูุฏ ุงููุญุฏุฉ ุงููุจุงุนุฉ
bool soldAsLargeUnit = (quantity_large_unit > 0);
double soldUnitsCount = soldAsLargeUnit ? quantity_large_unit : quantity_individual;

// 2. ุชุญุฏูุฏ ุงูุชูููุฉ ููู ูุญุฏุฉ
if (actual_cost_price != null) {
  // ุงุณุชุฎุฏู ุงูุชูููุฉ ุงููุนููุฉ ุงููุฎุฒูุฉ ูู ุงููุงุชูุฑุฉ
  costPerUnit = actual_cost_price;
} else if (soldAsLargeUnit) {
  // ุจูุน ุจูุญุฏุฉ ูุจูุฑุฉ (ููุฉุ ูุฑุชููุ ุฅูุฎ)
  if (unitCosts[sale_type] != null) {
    // ุงุณุชุฎุฏู ุงูุชูููุฉ ุงููุฎุฒูุฉ ูููุญุฏุฉ ุงููุจูุฑุฉ
    costPerUnit = unitCosts[sale_type];
  } else {
    // ุงุญุณุจ ุงูุชูููุฉ ูู ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ
    if (product_unit == 'meter' && sale_type == 'ููุฉ') {
      costPerUnit = product_cost_price * length_per_unit;
    } else {
      costPerUnit = product_cost_price * units_in_large_unit;
    }
  }
} else {
  // ุจูุน ุจุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ (ูุทุนุฉ ุฃู ูุชุฑ)
  costPerUnit = product_cost_price;
}

// 3. ุญุณุงุจ ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ
totalCost = costPerUnit * soldUnitsCount;
```

### 2. ุญุณุงุจ ุตุงูู ุงููุจูุนุงุช

```dart
// ุตุงูู ุงููุจูุนุงุช = ุฅุฌูุงูู ุงููุจูุนุงุช - ุงูุฑุงุฌุน
netSales = total_amount - return_amount;
```

### 3. ุญุณุงุจ ุงูุฑุจุญ

```dart
// ุงูุฑุจุญ = ุตุงูู ุงููุจูุนุงุช - ุงูุชูููุฉ
profit = netSales - totalCost;
```

---

## ุงูุชุนุงูู ูุน ุงูุชุณููุงุช (invoice_adjustments)

### ุฃููุงุน ุงูุชุณููุงุช:

#### 1. ุชุณููุฉ ุจูุฏ (product_id ููุฌูุฏ)
```dart
// ุญุณุงุจ ุงููุจูุนุงุช
salesContribution = (type == 'debit' ? 1 : -1) * quantity * price;

// ุชุญููู ุงููููุฉ ูููุญุฏุฉ ุงูุฃุณุงุณูุฉ
if (product_unit == 'meter' && sale_type == 'ููุฉ') {
  baseQty = quantity * (units_in_large_unit > 0 ? units_in_large_unit : length_per_unit);
} else if (sale_type == 'ูุทุนุฉ' || sale_type == 'ูุชุฑ') {
  baseQty = quantity;
} else {
  baseQty = quantity * units_in_large_unit;
}

// ุญุณุงุจ ุงูุชูููุฉ
signedBaseQty = (type == 'debit' ? 1 : -1) * baseQty;
costContribution = product_cost_price * signedBaseQty;

// ุญุณุงุจ ุงูุฑุจุญ
profitContribution = salesContribution - costContribution;
```

#### 2. ุชุณููุฉ ูุจูุบ (product_id ูุงุฑุบ)
```dart
// ุชุณููุฉ ูุงููุฉ ููุท (ูุจูุบ + ููุงุญุธุฉ)
salesContribution = amount_delta;
profitContribution = amount_delta; // ูุนุชุจุฑ ุฑุจุญ ูุงูู
```

---

## ุงูุชุนุงูู ูุน ุงููุนุงููุงุช ุงููุงููุฉ (transactions)

### ุฃููุงุน ุงููุนุงููุงุช:

#### 1. ุชุณุฏูุฏ ุฏูู (manual_payment)
```dart
// ูุง ูุคุซุฑ ุนูู ุงูุฑุจุญุ ููุท ูููู ุงูุฏูู
totalDebtPayments += abs(amount_changed);
```

#### 2. ุฅุถุงูุฉ ุฏูู (manual_debt, opening_balance)
```dart
// ูุถุงู ููุจูุน ุจุงูุฏูู
creditSales += amount_changed;
```

---

## ุงููุธุงู ุงููุฑูู ูููุญุฏุงุช

### ูุซุงู: ููุชุฌ ุจูุญุฏุฉ ูุชุฑ

```
ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ: ูุชุฑ
ุงููุญุฏุฉ ุงููุจูุฑุฉ: ููุฉ
ูุนุงูู ุงูุชุญููู: 50 ูุชุฑ/ููุฉ
ุชูููุฉ ุงููุชุฑ: 1000 ุฏููุงุฑ
ุชูููุฉ ุงูููุฉ: 50000 ุฏููุงุฑ (1000 ร 50)
```

### ุญุณุงุจ ุงูุชูููุฉ:
```dart
// ุจูุน 2 ููุฉ
quantity_large_unit = 2;
units_in_large_unit = 50;
product_cost_price = 1000; // ุชูููุฉ ุงููุชุฑ

// ุงูุชูููุฉ = ุชูููุฉ ุงููุชุฑ ร ุนุฏุฏ ุงูุฃูุชุงุฑ ูู ุงูููุฉ ร ุนุฏุฏ ุงูููุงุช
totalCost = 1000 ร 50 ร 2 = 100,000 ุฏููุงุฑ
```

---

## ุงูุชุดุงู ุงูุฃุฎุทุงุก (Clash Detection)

### ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ:

#### 1. ููุชุฌ ุจุฏูู ุชูููุฉ
```dart
if (product_cost_price == 0 || product_cost_price == null) {
  errors.add("ุงูููุชุฌ '${product_name}' ููุณ ูู ุชูููุฉ ูุญุฏุฏุฉ");
}
```

#### 2. ูุงุชูุฑุฉ ุจุชูููุฉ ุตูุฑ
```dart
if (totalCost == 0 && items.length > 0) {
  errors.add("ุงููุงุชูุฑุฉ #${invoice_id} ุจุชูููุฉ ุตูุฑ ุฑุบู ูุฌูุฏ ุจููุฏ");
}
```

#### 3. ูุณุจุฉ ุฑุจุญ ุบูุฑ ููุทููุฉ
```dart
profitMargin = (profit / totalSales) * 100;

if (profitMargin < 0) {
  warnings.add("ูุณุจุฉ ุฑุจุญ ุณุงูุจุฉ: ${profitMargin}%");
} else if (profitMargin < 5) {
  warnings.add("ูุณุจุฉ ุฑุจุญ ููุฎูุถุฉ ุฌุฏุงู: ${profitMargin}%");
} else if (profitMargin > 50) {
  warnings.add("ูุณุจุฉ ุฑุจุญ ุนุงููุฉ ุฌุฏุงู: ${profitMargin}% - ุชุญูู ูู ุงูุชูุงููู");
}
```

#### 4. ุชุถุงุฑุจ ูู ุงูุฃุณุนุงุฑ (Clash)
```dart
// ููุงุฑูุฉ ุณุนุฑ ุงูุจูุน ูุน ุงูุชูููุฉ
if (applied_price < cost_price) {
  errors.add("ููุงุด: ุณุนุฑ ุงูุจูุน (${applied_price}) ุฃูู ูู ุงูุชูููุฉ (${cost_price})");
}

// ููุงุฑูุฉ ุฃุณุนุงุฑ ุงูุจูุน ููููุชุฌ ููุณู
if (price_variance > 20%) {
  warnings.add("ุชุถุงุฑุจ ูู ุงูุฃุณุนุงุฑ: ุงูููุชุฌ '${product_name}' ูุจุงุน ุจุฃุณุนุงุฑ ูุชูุงูุชุฉ");
}
```

---

## ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: ูุงุชูุฑุฉ ุจุณูุทุฉ

```
ุงูููุชุฌ: ูุงุจู ููุฑุจุงุฆู
ุงููุญุฏุฉ: ูุชุฑ
ุงููููุฉ: 100 ูุชุฑ
ุณุนุฑ ุงูุจูุน: 2000 ุฏููุงุฑ/ูุชุฑ
ุงูุชูููุฉ: 1500 ุฏููุงุฑ/ูุชุฑ

ุงูุญุณุงุจ:
- ุฅุฌูุงูู ุงููุจูุนุงุช = 100 ร 2000 = 200,000 ุฏููุงุฑ
- ุฅุฌูุงูู ุงูุชูููุฉ = 100 ร 1500 = 150,000 ุฏููุงุฑ
- ุงูุฑุจุญ = 200,000 - 150,000 = 50,000 ุฏููุงุฑ
- ูุณุจุฉ ุงูุฑุจุญ = (50,000 / 200,000) ร 100 = 25%
```

### ูุซุงู 2: ูุงุชูุฑุฉ ุจูุญุฏุงุช ูุจูุฑุฉ

```
ุงูููุชุฌ: ูุงุจู ููุฑุจุงุฆู
ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ: ูุชุฑ
ุงููุญุฏุฉ ุงููุจูุฑุฉ: ููุฉ (50 ูุชุฑ)
ุงููููุฉ: 3 ููุงุช
ุณุนุฑ ุงูุจูุน: 95,000 ุฏููุงุฑ/ููุฉ
ุงูุชูููุฉ: 1500 ุฏููุงุฑ/ูุชุฑ

ุงูุญุณุงุจ:
- ุฅุฌูุงูู ุงููุจูุนุงุช = 3 ร 95,000 = 285,000 ุฏููุงุฑ
- ุงููููุฉ ุจุงููุชุฑ = 3 ร 50 = 150 ูุชุฑ
- ุฅุฌูุงูู ุงูุชูููุฉ = 150 ร 1500 = 225,000 ุฏููุงุฑ
- ุงูุฑุจุญ = 285,000 - 225,000 = 60,000 ุฏููุงุฑ
- ูุณุจุฉ ุงูุฑุจุญ = (60,000 / 285,000) ร 100 = 21.05%
```

### ูุซุงู 3: ูุงุชูุฑุฉ ูุน ุฑุงุฌุน

```
ุงูููุชุฌ: ูุงุจู ููุฑุจุงุฆู
ุงููููุฉ: 100 ูุชุฑ
ุณุนุฑ ุงูุจูุน: 2000 ุฏููุงุฑ/ูุชุฑ
ุงูุชูููุฉ: 1500 ุฏููุงุฑ/ูุชุฑ
ุงูุฑุงุฌุน: 20,000 ุฏููุงุฑ

ุงูุญุณุงุจ:
- ุฅุฌูุงูู ุงููุจูุนุงุช = 100 ร 2000 = 200,000 ุฏููุงุฑ
- ุตุงูู ุงููุจูุนุงุช = 200,000 - 20,000 = 180,000 ุฏููุงุฑ
- ุฅุฌูุงูู ุงูุชูููุฉ = 100 ร 1500 = 150,000 ุฏููุงุฑ
- ุงูุฑุจุญ = 180,000 - 150,000 = 30,000 ุฏููุงุฑ
- ูุณุจุฉ ุงูุฑุจุญ = (30,000 / 180,000) ร 100 = 16.67%
```

### ูุซุงู 4: ุชุณููุฉ ุจูุฏ

```
ููุน ุงูุชุณููุฉ: debit (ุฅุถุงูุฉ)
ุงูููุชุฌ: ูุงุจู ููุฑุจุงุฆู
ุงููููุฉ: 10 ูุชุฑ
ุงูุณุนุฑ: 2000 ุฏููุงุฑ/ูุชุฑ
ุงูุชูููุฉ: 1500 ุฏููุงุฑ/ูุชุฑ

ุงูุญุณุงุจ:
- ุงููุจูุนุงุช = 10 ร 2000 = 20,000 ุฏููุงุฑ
- ุงูุชูููุฉ = 10 ร 1500 = 15,000 ุฏููุงุฑ
- ุงูุฑุจุญ = 20,000 - 15,000 = 5,000 ุฏููุงุฑ
```

---

## ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุญููู

### 1. ุฌูุน ุงูุจูุงูุงุช
```dart
// ุฌูุจ ุฌููุน ุงูููุงุชูุฑ ุงููุญููุธุฉ
final invoices = await db.query('invoices', where: 'status = ?', whereArgs: ['ูุญููุธุฉ']);

// ุฌูุจ ุฌููุน ุงูุชุณููุงุช
final adjustments = await db.query('invoice_adjustments');

// ุฌูุจ ุฌููุน ุงููุนุงููุงุช
final transactions = await db.query('transactions');
```

### 2. ุญุณุงุจ ุงูุฃุฑุจุงุญ ูู ุงูููุงุชูุฑ
```dart
for (var invoice in invoices) {
  // ุฌูุจ ุจููุฏ ุงููุงุชูุฑุฉ ูุน ุจูุงูุงุช ุงูููุชุฌ
  final items = await db.rawQuery('''
    SELECT ii.*, p.*
    FROM invoice_items ii
    JOIN products p ON p.name = ii.product_name
    WHERE ii.invoice_id = ?
  ''', [invoice.id]);
  
  // ุญุณุงุจ ุงูุชูููุฉ ูุงูุฑุจุญ
  double invoiceCost = 0.0;
  for (var item in items) {
    invoiceCost += calculateItemCost(item);
  }
  
  double netSales = invoice.total_amount - (invoice.return_amount ?? 0);
  double profit = netSales - invoiceCost;
  
  totalProfit += profit;
}
```

### 3. ุฏูุฌ ุงูุชุณููุงุช
```dart
for (var adjustment in adjustments) {
  if (adjustment.product_id != null) {
    // ุชุณููุฉ ุจูุฏ
    double sales = calculateAdjustmentSales(adjustment);
    double cost = calculateAdjustmentCost(adjustment);
    totalProfit += (sales - cost);
  } else {
    // ุชุณููุฉ ูุจูุบ
    totalProfit += adjustment.amount_delta;
  }
}
```

### 4. ุงูุชุญูู ูู ุงูุฏูุฉ
```dart
// ุงูุชุญูู ูู ูุฌูุฏ ุฃุฎุทุงุก
if (totalCost == 0 && totalSales > 0) {
  errors.add("ุชูููุฉ ุตูุฑ ุฑุบู ูุฌูุฏ ูุจูุนุงุช");
}

// ุงูุชุญูู ูู ูุณุจุฉ ุงูุฑุจุญ
double profitMargin = (totalProfit / totalSales) * 100;
if (profitMargin < 0 || profitMargin > 100) {
  warnings.add("ูุณุจุฉ ุฑุจุญ ุบูุฑ ููุทููุฉ: ${profitMargin}%");
}
```

---

## ุงูุชูุตูุงุช ููุฐูุงุก ุงูุงุตุทูุงุนู

### ุนูุฏ ุชุญููู ุงูุฃุฑุจุงุญ:

1. โ **ุงุณุชุฎุฏู ููุณ ุงููููุฌูุฉ**: ุงุชุจุน ููุณ ุงูุฎุทูุงุช ุงููุณุชุฎุฏูุฉ ูู ุงูุฌุฑุฏ ุงูุดูุฑู
2. โ **ุชุญูู ูู ุงูุชูุงููู**: ุชุฃูุฏ ูู ูุฌูุฏ ุชูููุฉ ููู ููุชุฌ
3. โ **ุฑุงุนู ุงููุธุงู ุงููุฑูู**: ุงุญุณุจ ุงูุชูููุฉ ุญุณุจ ุงููุญุฏุฉ ุงููุจุงุนุฉ
4. โ **ุฏูุฌ ุงูุชุณููุงุช**: ูุง ุชูุณู ุฅุถุงูุฉ ุงูุชุณููุงุช ููุญุณุงุจุงุช
5. โ **ุงูุชุดู ุงูุฃุฎุทุงุก**: ุงุจุญุซ ุนู ุงูููุงุด ูุงูุชุถุงุฑุจ
6. โ **ูุฏู ุชูุตูุงุช**: ุงูุชุฑุญ ุญููู ูุชุญุณูู ุงูุฏูุฉ

### ุนูุฏ ุงูุชุดุงู ุฃุฎุทุงุก:

1. ๐ **ุญุฏุฏ ุงููุดููุฉ**: ุงุดุฑุญ ุงูุฎุทุฃ ุจูุถูุญ
2. ๐ **ูุฏู ุงูุฃุฑูุงู**: ุงุนุฑุถ ุงูุฃุฑูุงู ุงููุนููุฉ ูุงููุชููุนุฉ
3. ๐ก **ุงูุชุฑุญ ุญููู**: ูุฏู ุฎุทูุงุช ูุชุตุญูุญ ุงูุฎุทุฃ
4. โ๏ธ **ุตูู ุงูุฎุทูุฑุฉ**: ููุฒ ุจูู ุงูุฃุฎุทุงุก ุงูุญุฑุฌุฉ ูุงูุชุญุฐูุฑุงุช

---

## ุงูุฎูุงุตุฉ

ูููุงุณ ุงูุฃุฑุจุงุญ ุจุฏูุฉ ุนุงููุฉ ุฌุฏุงู:

1. **ุงุณุชุฎุฏู ุงููููุฌูุฉ ุงูุตุญูุญุฉ**: ููุณ ูููุฌูุฉ ุงูุฌุฑุฏ ุงูุดูุฑู
2. **ุฑุงุนู ุฌููุน ุงูุชูุงุตูู**: ุงููุธุงู ุงููุฑููุ ุงูุชุณููุงุชุ ุงููุนุงููุงุช
3. **ุชุญูู ูู ุงูุฏูุฉ**: ุงุจุญุซ ุนู ุงูุฃุฎุทุงุก ูุงูุชุถุงุฑุจ
4. **ูุฏู ุชูุงุฑูุฑ ูุงุถุญุฉ**: ุงุดุฑุญ ุงูุญุณุงุจุงุช ุจูุถูุญ
5. **ุงูุชุฑุญ ุชุญุณููุงุช**: ุณุงุนุฏ ุงููุณุชุฎุฏู ุนูู ุชุญุณูู ุฏูุฉ ุงูุจูุงูุงุช

ูุฐู ุงููููุฌูุฉ ุชุถูู:
- โ ุฏูุฉ ุนุงููุฉ ุฌุฏุงู ูู ุงูุญุณุงุจุงุช
- โ ุงูุชุดุงู ุงูุฃุฎุทุงุก ุชููุงุฆูุงู
- โ ุชูุตูุงุช ุฐููุฉ ููููุฏุฉ
- โ ุซูุฉ ูุงููุฉ ูู ุงููุชุงุฆุฌ
