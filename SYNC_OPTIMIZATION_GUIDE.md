# ุฏููู ูุธุงู ุงููุฒุงููุฉ ุงููุญุณูู ูููุณุงุญุฉ ุงููุญุฏูุฏุฉ

## ๐ฏ ุงููุฏู
ูุธุงู ูุฒุงููุฉ ูุตูู ุฎุตูุตุงู ููุนูู ูุน Google Drive ุจูุณุงุญุฉ ูุญุฏูุฏุฉ (5GB ุฃู ุฃูู).

---

## โ ุงูุชุญุณููุงุช ุงููุทุจูุฉ

### 1. Verify-After-Write Lock (ุญู Race Condition)
```
ุงููุดููุฉ: ุฌูุงุฒุงู ูุฏ ูุญุตูุงู ุนูู ุงูููู ูู ููุณ ุงูููุช
ุงูุญู: 
  1. ุฑูุน ููู ุงูููู
  2. ุงูุชุธุงุฑ 200-500ms ุนุดูุงุฆู
  3. ุงูุชุญูู ูู ุฃู ููููุง ูู ุงููุญูุฏ
  4. ุฅุฐุง ูุฌุฏ ููู ุขุฎุฑ ุฃูุฏู โ ุญุฐู ููููุง ูุงูุงูุณุญุงุจ
```

### 2. Batching Strategy (ุชุฌููุน ุงูุนูููุงุช)
```
ุงููุดููุฉ: 500 ุนูููุฉ = 500 ุทูุจ ุดุจูุฉ = ุจุทุก + Rate Limit
ุงูุญู:
  - ุชุฌููุน ุฌููุน ุงูุนูููุงุช ูู ููู batch ูุงุญุฏ
  - ุทูุจ ุดุจูุฉ ูุงุญุฏ ุจุฏูุงู ูู 500
  - ุชุณุฑูุน 10x-50x
```

### 3. GZIP Compression (ุถุบุท ุงูุจูุงูุงุช)
```
ุงููุดููุฉ: ูููุงุช JSON ูุจูุฑุฉ ุชุณุชููู ุงููุณุงุญุฉ
ุงูุญู:
  - ุถุบุท ุฌููุน ุงููููุงุช ุจู GZIP
  - ุชูููุฑ 70-90% ูู ุงููุณุงุญุฉ
  - ูุซุงู: 100KB โ 10KB
```

### 4. Rolling Snapshots (ุตูุฑ ุฏูุฑูุฉ)
```
ุงููุดููุฉ: ุขูุงู ูููุงุช ุงูุนูููุงุช = ุจุทุก ูู ุฅุนุงุฏุฉ ุงูุจูุงุก
ุงูุญู:
  - ุฅูุดุงุก snapshot ูู 200 ุนูููุฉ
  - ุงูุงุญุชูุงุธ ุจุขุฎุฑ 3 snapshots ููุท
  - ุฌูุงุฒ ุฌุฏูุฏ ูุญููู snapshot + ุงูุนูููุงุช ุงูุฌุฏูุฏุฉ ููุท
```

### 5. Smart Cleanup (ุชูุธูู ุฐูู)
```
ุงููุดููุฉ: ุงููุณุงุญุฉ ุชูุชูุฆ ูุน ุงูููุช
ุงูุญู:
  - ูุญุต ุงููุณุงุญุฉ ูุจู ูู ูุฒุงููุฉ
  - ุชูุธูู ุชููุงุฆู ุนูุฏ 80% ูู ุงูุญุฏ
  - ุญุฐู ุงูู batches ุงููุฏููุฉ (ุงูุฅุจูุงุก ุนูู 10)
  - ุญุฐู ุงูู snapshots ุงููุฏููุฉ (ุงูุฅุจูุงุก ุนูู 3)
```

---

## ๐ ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ

```dart
OptimizedSyncConfig(
  // ุงูููู
  lockTimeout: Duration(minutes: 3),
  maxLockRetries: 6,
  
  // Batching
  maxOperationsPerBatch: 500,
  
  // Snapshots
  snapshotEveryNOperations: 200,
  maxSnapshotsToKeep: 3,
  maxOperationFilesToKeep: 10,
  
  // ุงูุชูุธูู
  keepOperationsDays: 14,
  maxStorageMB: 500,  // 10% ูู 5GB
  cleanupThresholdPercent: 0.8,
  
  // ุงูุถุบุท
  enableCompression: true,
  compressionLevel: 6,
)
```

---

## ๐ ูููู ุงููุฌูุฏุงุช ูู Google Drive

```
DebtBook_Sync_v3/
โโโ .lock                    # ููู ุงูููู
โโโ manifest.json.gz         # ุงูููุฑุณ ุงูุฑุฆูุณู (ูุถุบูุท)
โโโ snapshots/
โ   โโโ snapshot_v200_xxx.json.gz
โ   โโโ snapshot_v400_xxx.json.gz
โ   โโโ snapshot_v600_xxx.json.gz
โโโ batches/
    โโโ batch_xxx_device1.json.gz
    โโโ batch_xxx_device2.json.gz
    โโโ ...
```

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ุงูุชููุฆุฉ
```dart
final syncEngine = OptimizedSyncEngine(
  config: OptimizedSyncConfig(
    maxStorageMB: 300,  // ุชุฎุตูุต 300MB ููุท
  ),
);

await syncEngine.initialize(
  httpClient: authenticatedClient,
  deviceId: 'unique_device_id',
  deviceName: 'ุฌูุงุฒ ุงููุณุชุฎุฏู',
);
```

### ุงููุฒุงููุฉ ุงููุงููุฉ
```dart
final report = await syncEngine.performOptimizedSync();

if (report.success) {
  print('โ ุชูุช ุงููุฒุงููุฉ');
  print('ุชูุฒูู: ${report.operationsDownloaded}');
  print('ุฑูุน: ${report.operationsUploaded}');
} else {
  print('โ ูุดู: ${report.errorMessage}');
}
```

### ุงููุฒุงููุฉ ุงูุณุฑูุนุฉ (ุชูุฒูู ููุท)
```dart
final report = await syncEngine.performQuickSync();
```

### ูุญุต ุงููุณุงุญุฉ
```dart
final storage = await syncEngine.checkStorageUsage();
print('ุงููุณุงุญุฉ ุงููุณุชุฎุฏูุฉ: ${storage.totalMB}MB');
```

### ุงูุชูุธูู ุงููุฏูู
```dart
// ุชูุธูู ุฐูู
await syncEngine.performSmartCleanup();

// ุชูุธูู ุดุงูู (ููุญุงูุงุช ุงูุทุงุฑุฆุฉ)
await syncEngine.performDeepCleanup();
```

---

## ๐ ุชูุฏูุฑ ุงุณุชููุงู ุงููุณุงุญุฉ

| ุงูุนูุตุฑ | ุงูุญุฌู ุงูุชูุฑูุจู |
|--------|---------------|
| Manifest | ~5KB |
| Snapshot (1000 ุนููู + 5000 ูุนุงููุฉ) | ~200KB ูุถุบูุท |
| Batch (100 ุนูููุฉ) | ~20KB ูุถุบูุท |
| 3 Snapshots | ~600KB |
| 10 Batches | ~200KB |
| **ุงูุฅุฌูุงูู ุงูุชูุฑูุจู** | **~1MB** |

ูุน ุงูุงุณุชุฎุฏุงู ุงูููุซู (ุณูุฉ ูุงููุฉ):
- ~50 Snapshot (ููุญุฐู ุงููุฏูู) โ 600KB
- ~500 Batch (ููุญุฐู ุงููุฏูู) โ 200KB
- **ุงูุญุฏ ุงูุฃูุตู ุงููุชููุน: 50-100MB**

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ูุง ุชุบูุฑ `_syncFolderName`** ุจุนุฏ ุจุฏุก ุงูุงุณุชุฎุฏุงู
2. **ุงูููุชุงุญ ุงูุณุฑู** ูุฌุจ ุฃู ูููู ูุชุทุงุจูุงู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ
3. **ุงูุถุบุท** ูุฒูุฏ ููุช ุงููุนุงูุฌุฉ ููููุงู ููู ูููุฑ ูุณุงุญุฉ ูุจูุฑุฉ
4. **ุงูุชูุธูู ุงูุชููุงุฆู** ูุญุฏุซ ููุท ุนูุฏ ุชุฌุงูุฒ 80% ูู ุงูุญุฏ

---

## ๐ง ุชุฎุตูุต ูููุณุงุญุฉ ุงูุฃูู

ุฅุฐุง ูุงูุช ุงููุณุงุญุฉ ุฃูู ูู 1GB:

```dart
OptimizedSyncConfig(
  maxSnapshotsToKeep: 2,
  maxOperationFilesToKeep: 5,
  keepOperationsDays: 7,
  maxStorageMB: 100,
  snapshotEveryNOperations: 500,
)
```
