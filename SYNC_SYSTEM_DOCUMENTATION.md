# ๐ ูุธุงู ุงููุฒุงููุฉ ูุงุฆู ุงูุฃูุงู - Enterprise Grade Sync System

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทููุฑ ูุธุงู ูุฒุงููุฉ ูุชูุฏู ูุถูู ุฃูุงู ุงูุจูุงูุงุช ุจูุณุจุฉ 99%+ ูุน ุฏุนู:
- โ ACID Compliance - ูู ุนูููุฉ ุฅูุง ุชูุฌุญ ุจุงููุงูู ุฃู ุชูุดู ุจุงููุงูู
- โ Idempotency - ุชูุฑุงุฑ ููุณ ุงูุนูููุฉ ูุนุทู ููุณ ุงููุชูุฌุฉ
- โ Conflict-Free - ูุง ูููู ุญุฏูุซ ุชุนุงุฑุถ ูููุฏ ุงูุจูุงูุงุช
- โ Audit Trail - ูู ุชุบููุฑ ูุณุฌู ููููู ุชุชุจุนู
- โ Rollback Ready - ูููู ุงูุชุฑุงุฌุน ุนู ุฃู ุนูููุฉ
- โ Offline First - ูุนูู ุจุฏูู ุฅูุชุฑูุช ููุฒุงูู ูุงุญูุงู
- โ Cryptographic - ูู ุงูุจูุงูุงุช ูููุนุฉ ููุดูุฑุฉ

## ๐ ูููู ุงููููุงุช

```
lib/services/sync/
โโโ sync.dart                 # ููู ุงูุชุตุฏูุฑ ุงูุฑุฆูุณู
โโโ sync_models.dart          # ููุงุฐุฌ ุงูุจูุงูุงุช
โโโ sync_operation.dart       # ูููุฐุฌ ุงูุนูููุฉ + Causality Vector
โโโ sync_security.dart        # ุงูุชุดููุฑ ูุงูุชูููุน + Merkle Tree
โโโ sync_engine.dart          # ูุญุฑู ุงููุฒุงููุฉ ุงูุฑุฆูุณู
โโโ sync_local_storage.dart   # ุงูุชุฎุฒูู ุงููุญูู
โโโ sync_tracker.dart         # ุชุชุจุน ุงูุชุบููุฑุงุช ุชููุงุฆูุงู
```

## ๐๏ธ ุงูุจููุฉ ุนูู Google Drive

```
DebtBook_Sync_v2/
โโโ .lock                     # ููู ุงููุฒุงููุฉ
โโโ manifest.json             # ููุฑุณ ุงูุฅุตุฏุงุฑุงุช
โโโ devices/                  # ูููุงุช ุงูุฃุฌูุฒุฉ
โ   โโโ {device_A}.json
โ   โโโ {device_B}.json
โโโ operations/               # ุณุฌู ุงูุนูููุงุช
โ   โโโ op_xxx.json
โ   โโโ ...
โโโ snapshots/                # ูุณุฎ ุงุญุชูุงุทูุฉ
โโโ conflicts/                # ุงูุชุนุงุฑุถุงุช ุงููุญููุธุฉ
```


## ๐ ุฎูุงุฑุฒููุฉ ุงููุฒุงููุฉ (11 ูุฑุญูุฉ)

### ุงููุฑุญูุฉ 0: ุงูุชุญุถูุฑ ุงููุญูู
- ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุญููุฉ
- ุญุณุงุจ checksums ูุฌููุน ุงูุฌุฏุงูู
- ุชุฌููุน ุงูุนูููุงุช ุงููุนููุฉ

### ุงููุฑุญูุฉ 1: ุงูุญุตูู ุนูู ุงูููู
- ูุฑุงุกุฉ ููู ุงูููู
- ุฅุฐุง ูุงู ูุดุบููุงู: ุงูุชุธุงุฑ ูุฅุนุงุฏุฉ ุงููุญุงููุฉ
- ุฅูุดุงุก ููู ุฌุฏูุฏ ุจุตูุงุญูุฉ 3 ุฏูุงุฆู
- ุชุดุบูู heartbeat ููุชุฌุฏูุฏ ุงูุชููุงุฆู

### ุงููุฑุญูุฉ 2: ุชูุฒูู ุงูุญุงูุฉ ุงูุจุนูุฏุฉ
- ุชูุฒูู manifest.json
- ุชูุฒูู ูููุงุช ุงูุฃุฌูุฒุฉ ุงูุฃุฎุฑู
- ุชูุฒูู ุงูุนูููุงุช ุงูุฌุฏูุฏุฉ

### ุงููุฑุญูุฉ 3: ุงูุชุญูู ูุงููุตุงุฏูุฉ
- ุงูุชุญูู ูู checksum ูู ุนูููุฉ
- ุงูุชุญูู ูู ุงูุชูููุน ุงูุฑููู (HMAC-SHA256)

### ุงููุฑุญูุฉ 4: ูุดู ุงูุชุนุงุฑุถุงุช
- ููุงุฑูุฉ ุงูุนูููุงุช ุงููุญููุฉ ุจุงูุจุนูุฏุฉ
- ุงุณุชุฎุฏุงู Causality Vector ููุดู ุงูุชุนุงุฑุถุงุช

### ุงููุฑุญูุฉ 5: ุญู ุงูุชุนุงุฑุถุงุช
- Last-Write-Wins ููุชุนุงุฑุถุงุช ุงูุจุณูุทุฉ
- ุญูุธ ุงูุชุนุงุฑุถุงุช ุงููุนูุฏุฉ ูููุฑุงุฌุนุฉ ุงููุฏููุฉ

### ุงููุฑุญูุฉ 6: ุชุทุจูู ุงูุนูููุงุช ุงููุงุฑุฏุฉ
- ุจุฏุก Database Transaction
- ุชุทุจูู ูู ุนูููุฉ ุจุงูุชุฑุชูุจ
- ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุฃุฑุตุฏุฉ ุงููุชุฃุซุฑุฉ
- Rollback ูู ุญุงูุฉ ุงููุดู

### ุงููุฑุญูุฉ 7: ุฑูุน ุงูุนูููุงุช ุงููุญููุฉ
- ุฑูุน ูู ุนูููุฉ ุฅูู operations/
- ุชุญุฏูุซ ููู ุงูุฌูุงุฒ

### ุงููุฑุญูุฉ 8: ุชุญุฏูุซ ุงูููุฑุณ
- ุฒูุงุฏุฉ global_sequence
- ุชุญุฏูุซ checksums
- ุญุณุงุจ Merkle Root ุฌุฏูุฏ

### ุงููุฑุญูุฉ 9: ุฅุฑุณุงู ุงูุชุฃููุฏุงุช
- ุชุญุฏูุซ acknowledgments ูู ุงูุนูููุงุช

### ุงููุฑุญูุฉ 10: ุงูุชูุธูู
- ุฅูุดุงุก snapshot ูู 100 ุนูููุฉ
- ุญุฐู ุงูุนูููุงุช ุงููุฏููุฉ (> 30 ููู)

### ุงููุฑุญูุฉ 11: ุงูุชุญูู ุงูููุงุฆู
- ููุงุฑูุฉ checksums ุงููุญููุฉ ุจุงูุจุนูุฏุฉ

## ๐ก๏ธ ุขููุงุช ุงูุฃูุงู

### 1. ุงูุชูููุน ุงูุฑููู (HMAC-SHA256)
```dart
signature = HMAC-SHA256(operationId|deviceId|localSequence|checksum, secretKey)
```

### 2. Causality Vector
ูุชุชุจุน ุงูุณุจุจูุฉ ุจูู ุงูุนูููุงุช ูููุน ุงูุชุนุงุฑุถุงุช:
```dart
{
  "MAC_A": 456,  // ุขุฎุฑ ุชุณูุณู ูู ุฌูุงุฒ A
  "MAC_B": 234   // ุขุฎุฑ ุชุณูุณู ูู ุฌูุงุฒ B
}
```

### 3. Merkle Tree
ููุชุญูู ุงูุณุฑูุน ูู ุณูุงูุฉ ุงูุจูุงูุงุช:
```
        Root
       /    \
    H(AB)   H(CD)
    /  \    /  \
   A    B  C    D
```

### 4. ุงูููู ุงูููุฒุน (Distributed Lock)
- ุตูุงุญูุฉ 3 ุฏูุงุฆู
- ุชุฌุฏูุฏ ุชููุงุฆู ูู 30 ุซุงููุฉ
- ุงูุชูุงุก ุชููุงุฆู ููุญูุงูุฉ ูู ุงูุงููุทุงุน

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุงูุชููุฆุฉ
```dart
import 'package:debt_book/services/sync/sync.dart';

// ุชููุฆุฉ ุงููุชุชุจุน ุนูุฏ ุจุฏุก ุงูุชุทุจูู
await SyncTrackerInstance.initialize();

// ุชููุฆุฉ ูุญุฑู ุงููุฒุงููุฉ
final syncEngine = SyncEngine();
await syncEngine.initialize(
  httpClient: authenticatedClient,
  deviceId: 'MAC_A_WIFI_BT',
  deviceName: 'ุญุงุณูุจ ุงููุญู',
);
```

### 2. ุชุชุจุน ุงูุชุบููุฑุงุช ุชููุงุฆูุงู
```dart
final tracker = SyncTrackerInstance.instance;

// ุนูุฏ ุฅูุดุงุก ุนููู
final syncUuid = await tracker.trackCustomerCreate(customerData);

// ุนูุฏ ุชุญุฏูุซ ุนููู
await tracker.trackCustomerUpdate(syncUuid, oldData, newData);

// ุนูุฏ ุฅูุดุงุก ูุนุงููุฉ
await tracker.trackTransactionCreate(txData, customerSyncUuid);
```

### 3. ุชูููุฐ ุงููุฒุงููุฉ
```dart
syncEngine.onStatusChange = (status) => print(status);
syncEngine.onProgress = (progress) => updateProgressBar(progress);

final report = await syncEngine.performFullSync();

if (report.success) {
  print('โ ุชูุช ุงููุฒุงููุฉ ุจูุฌุงุญ');
  print('ุชู ุชูุฒูู: ${report.operationsDownloaded}');
  print('ุชู ุฑูุน: ${report.operationsUploaded}');
} else {
  print('โ ูุดูุช ุงููุฒุงููุฉ: ${report.errorMessage}');
}
```

## โ๏ธ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

| ููุน ุงูุฎุทุฃ | ุงููุตู | ูุงุจู ููุงุณุชุฑุฏุงุฏ |
|-----------|-------|----------------|
| networkError | ุฎุทุฃ ูู ุงูุดุจูุฉ | โ ูุนู |
| lockAcquisitionFailed | ูุดู ุงูุญุตูู ุนูู ุงูููู | โ ูุนู |
| signatureInvalid | ุชูููุน ุบูุฑ ุตุงูุญ | โ ูุง |
| checksumMismatch | ุนุฏู ุชุทุงุจู checksum | โ ูุง |
| conflictDetected | ุชุนุงุฑุถ ููุชุดู | โ ูุนู |
| rollbackRequired | ูุชุทูุจ ุชุฑุงุฌุน | โ ูุนู |

## ๐ง ุงูุฅุนุฏุงุฏุงุช

```dart
const config = SyncConfig(
  lockTimeout: Duration(minutes: 3),
  lockRetryInterval: Duration(seconds: 10),
  maxLockRetries: 5,
  heartbeatInterval: Duration(seconds: 30),
  snapshotEveryNOperations: 100,
  keepOperationsDays: 30,
  autoResolveConflicts: true,
  conflictResolutionStrategy: 'LAST_WRITE_WINS',
);
```

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูููุชุงุญ ุงูุณุฑู**: ูุชู ุฅูุดุงุคู ุชููุงุฆูุงู ุนูุฏ ุฃูู ุงุณุชุฎุฏุงู ูููุญูุธ ูู Secure Storage
2. **sync_uuid**: ูุชู ุชุนูููู ุชููุงุฆูุงู ูุฌููุน ุงูุณุฌูุงุช ุงูููุฌูุฏุฉ
3. **Soft Delete**: ุงูุญุฐู ูุง ูุฒูู ุงูุณุฌูุงุช ูุนููุงู ุจู ูุถุน ุนูุงูุฉ is_deleted
4. **ุงููุณุฎ ุงูุงุญุชูุงุทู**: ูุชู ุฅูุดุงุก ูุณุฎุฉ ูุญููุฉ ูุจู ูู ูุฒุงููุฉ

---

## ๐ ุงููุณุฎุฉ ุงููุญุณููุฉ ูููุณุงุญุฉ ุงููุญุฏูุฏุฉ (v3.0)

ุชู ุฅุถุงูุฉ ูุณุฎุฉ ูุญุณููุฉ ุฎุตูุตุงู ููุนูู ูุน ูุณุงุญุฉ ูุญุฏูุฏุฉ (5GB ุฃู ุฃูู):

### ุงูููู: `sync_engine_optimized.dart`

### ุงูุชุญุณููุงุช ุงูุฑุฆูุณูุฉ:

| ุงูุชุญุณูู | ุงููุงุฆุฏุฉ |
|---------|---------|
| **Verify-After-Write Lock** | ุญู ูุดููุฉ Race Condition |
| **Batching** | ุชูููู ุทูุจุงุช ุงูุดุจูุฉ 50x |
| **GZIP Compression** | ุชูููุฑ 70-90% ูู ุงููุณุงุญุฉ |
| **Rolling Snapshots** | ุงูุฅุจูุงุก ุนูู 3 snapshots ููุท |
| **Smart Cleanup** | ุชูุธูู ุชููุงุฆู ุนูุฏ 80% |

### ุงูุงุณุชุฎุฏุงู:

```dart
import 'sync_engine_optimized.dart';

final engine = OptimizedSyncEngine(
  config: OptimizedSyncConfig(
    maxStorageMB: 300,        // 300MB ูุญุฏ ุฃูุตู
    maxSnapshotsToKeep: 3,    // 3 snapshots ููุท
    enableCompression: true,   // ุถุบุท GZIP
  ),
);

await engine.initialize(
  httpClient: client,
  deviceId: deviceId,
);

// ูุฒุงููุฉ ูุงููุฉ
final report = await engine.performOptimizedSync();

// ูุญุต ุงููุณุงุญุฉ
final storage = await engine.checkStorageUsage();
print('ุงููุณุงุญุฉ: ${storage.totalMB}MB');
```

### ุชูุฏูุฑ ุงููุณุงุญุฉ:
- **ุงูุญุฏ ุงูุฃูุตู ุงููุชููุน:** 50-100MB
- **ููุงุณุจ ูู:** 5GB Google Drive (ูุณุชุฎุฏู 1-2% ููุท)

๐ **ูููุฒูุฏ:** ุฑุงุฌุน `SYNC_OPTIMIZATION_GUIDE.md`

---

**ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ:** Kiro AI Assistant  
**ุงูุชุงุฑูุฎ:** 5 ุฏูุณูุจุฑ 2025  
**ุงูุฅุตุฏุงุฑ:** 3.0.0 (ูุญุณูู ูููุณุงุญุฉ)  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู
